<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Padel Leaderboard</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --line:rgba(255,255,255,.12);
      --text:#e9ecff; --muted:rgba(233,236,255,.72);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 15% 0%, #1a2a6c 0%, #0b1020 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:28px auto; padding:0 16px}
    .card{
      background: rgba(18,26,51,.86);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    h1{margin:0; font-size:22px; letter-spacing:.3px}
    .sub{margin-top:6px; color:var(--muted); font-size:13px}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
    }
    .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input,select{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(11,16,32,.65);
      color: var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(233,236,255,.45)}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(11,16,32,.55);
      font-size:12px; color:var(--muted);
    }

    /* Podium */
    .podium{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, 1fr);
      margin-top:12px;
    }
    @media (max-width: 760px){
      .podium{grid-template-columns:1fr}
    }
    .podiumCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(11,16,32,.55);
      /* animation base */
      transform: translateY(10px) scale(.98);
      opacity: 0;
      animation: podiumIn 650ms cubic-bezier(.2,.9,.2,1) forwards;
      will-change: transform, opacity;
    }
    .podiumCard:hover{
      transform: translateY(-2px) scale(1.01);
      transition: transform 180ms ease;
    }
    .podiumTitle{font-size:20px}
    .podiumMeta{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35}
    .podiumGlow{
      position: relative;
      overflow: hidden;
    }
    .podiumGlow:before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%);
      transform: rotate(12deg);
      opacity:.55;
      pointer-events:none;
    }

    @keyframes podiumIn{
      0%   { opacity:0; transform: translateY(14px) scale(.97); filter: blur(1px); }
      60%  { opacity:1; transform: translateY(0px)  scale(1.01); filter: blur(0px); }
      100% { opacity:1; transform: translateY(0px)  scale(1); }
    }

    /* Table wrapper: helps mobile spacing + right padding */
    .tableWrap{
      margin-top:12px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 10px; /* makes last column not kiss the edge on iPhone */
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      min-width: 760px; /* so it won't squeeze columns too much on phones */
    }
    th,td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      white-space: nowrap;
    }
    th{font-size:12px; color:rgba(233,236,255,.75)}
    tbody tr:hover{background: rgba(159,176,255,.06)}
    .num{text-align:right; font-variant-numeric: tabular-nums}
    .muted{color:var(--muted); font-size:12px}

    /* ‚úÖ Fix ‚ÄúWinrate mepet kanan‚Äù: add extra right padding for last column */
    table th:last-child,
    table td:last-child{
      padding-right: 18px;
    }

    /* Mobile polish */
    @media (max-width: 480px){
      .wrap{padding:0 12px}
      .card{padding:12px}
      input,select{width: 100%;}
      .right{width:100%;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <div>
          <h1>Padel Leaderboard</h1>
          <div class="sub">Top 3 podium + leaderboard dari Google Sheets (CSV). Auto refresh tiap 60 detik.</div>
        </div>

        <div class="right">
          <input id="search" placeholder="Search nama..." />
          <select id="sortBy" title="Sort">
            <option value="points_desc">Points (tinggi ‚Üí rendah)</option>
            <option value="win_desc">Win (tinggi ‚Üí rendah)</option>
            <option value="played_desc">Played (tinggi ‚Üí rendah)</option>
            <option value="name_asc">Name (A ‚Üí Z)</option>
            <option value="winrate_desc">Winrate (tinggi ‚Üí rendah)</option>
          </select>
          <span class="pill">Total pemain: <b id="count">0</b></span>
        </div>
      </div>

      <div id="podium" class="podium"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:52px">#</th>
              <th>Name</th>
              <th class="num">Played</th>
              <th class="num">Win</th>
              <th class="num">Lose</th>
              <th class="num">Points</th>
              <th class="num">Winrate</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px">
        Kalau datanya belum muncul: pastikan Google Sheets kamu sudah <i>Publish to web</i> sebagai CSV dan kolomnya sesuai.
      </div>
    </div>
  </div>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQa_3k4XRT_CetrvxU0E2wlGlsis3bbt9mRFk85jfLb8w4FsGBxadPNPGQRdjkCU9_4Wywmu1wr2f9P/pub?gid=0&single=true&output=csv";

  let rows = [];

  const elTbody = document.getElementById("tbody");
  const elSearch = document.getElementById("search");
  const elSortBy = document.getElementById("sortBy");
  const elCount  = document.getElementById("count");
  const elPodium = document.getElementById("podium");

  function toNum(v){
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) ? n : 0;
  }

  // CSV parser (supports quoted values)
  function parseCSV(text){
    const out = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }

      if (!inQuotes && ch === ","){ row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur);
        if (row.some(cell => String(cell).trim() !== "")) out.push(row);
        row = []; cur = "";
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if (row.some(cell => String(cell).trim() !== "")) out.push(row);
    return out;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function winrate(p){
    if (!p.played) return 0;
    return (p.win / p.played) * 100;
  }

  function normalizeHeaders(h){
    return String(h || "").trim().toLowerCase();
  }

  function toPlayers(parsed){
    const header = parsed[0] || [];
    const idx = {};
    header.forEach((h, i) => idx[normalizeHeaders(h)] = i);

    const required = ["name","played","win","lose","points"];
    const missing = required.filter(k => !(k in idx));

    // fallback fixed order 0..4 if headers don‚Äôt match
    if (missing.length){
      return parsed.slice(1).map(cols => ({
        name: (cols[0] || "").trim(),
        played: toNum(cols[1]),
        win: toNum(cols[2]),
        lose: toNum(cols[3]),
        points: toNum(cols[4]),
      })).filter(p => p.name);
    }

    return parsed.slice(1).map(cols => ({
      name: (cols[idx.name] || "").trim(),
      played: toNum(cols[idx.played]),
      win: toNum(cols[idx.win]),
      lose: toNum(cols[idx.lose]),
      points: toNum(cols[idx.points]),
    })).filter(p => p.name);
  }

  function applyFilterSort(list){
    const q = elSearch.value.trim().toLowerCase();
    let out = q ? list.filter(p => p.name.toLowerCase().includes(q)) : [...list];

    const mode = elSortBy.value;
    out.sort((a,b)=>{
      if (mode === "points_desc") return (b.points-a.points) || (b.win-a.win) || a.name.localeCompare(b.name);
      if (mode === "win_desc") return (b.win-a.win) || (b.points-a.points) || a.name.localeCompare(b.name);
      if (mode === "winrate_desc") {
  const wa = a.played ? a.win / a.played : 0;
  const wb = b.played ? b.win / b.played : 0;
  return (wb - wa) || (b.points - a.points) || a.name.localeCompare(b.name);
}
      if (mode === "played_desc") return (b.played-a.played) || (b.points-a.points) || a.name.localeCompare(b.name);
      if (mode === "name_asc") return a.name.localeCompare(b.name);
      return 0;
    });

    return out;
  }

 function renderPodium(allRows){
  const mode = elSortBy.value;

  const sorted = [...allRows].sort((a,b)=>{
    if (mode === "points_desc") return (b.points-a.points) || (b.win-a.win) || a.name.localeCompare(b.name);
    if (mode === "win_desc") return (b.win-a.win) || (b.points-a.points) || a.name.localeCompare(b.name);
    if (mode === "winrate_desc") {
      const wa = a.played ? a.win / a.played : 0;
      const wb = b.played ? b.win / b.played : 0;
      return (wb - wa) || (b.points - a.points) || a.name.localeCompare(b.name);
    }
    if (mode === "played_desc") return (b.played-a.played) || (b.points-a.points) || a.name.localeCompare(b.name);
    if (mode === "name_asc") return a.name.localeCompare(b.name);
    return 0;
  });

  const top = sorted.slice(0,3);

  const medals = ["ü•á","ü•à","ü•â"];
  elPodium.innerHTML = "";

  if (top.length === 0){
    elPodium.innerHTML = `<div class="muted">Belum ada data untuk podium.</div>`;
    return;
  }

  top.forEach((p, i)=>{
    const wr = winrate(p).toFixed(1) + "%";
    const div = document.createElement("div");
    div.className = "podiumCard podiumGlow";
    div.style.animationDelay = `${i * 120}ms`;
    div.innerHTML = `
      <div class="podiumTitle">${medals[i]} <b>${escapeHtml(p.name)}</b></div>
      <div class="podiumMeta">
        Played: <b>${p.played}</b> ‚Ä¢ W: <b>${p.win}</b> ‚Ä¢ L: <b>${p.lose}</b><br/>
        Points: <b>${p.points}</b> ‚Ä¢ Winrate: <b>${wr}</b>
      </div>
    `;
    elPodium.appendChild(div);
  });
}

    const medals = ["ü•á","ü•à","ü•â"];
    elPodium.innerHTML = "";

    if (top.length === 0){
      elPodium.innerHTML = `<div class="muted">Belum ada data untuk podium.</div>`;
      return;
    }

    top.forEach((p, i)=>{
      const wr = winrate(p).toFixed(1) + "%";
      const div = document.createElement("div");
      div.className = "podiumCard podiumGlow";

      // ‚úÖ stagger animation delay (nice!)
      div.style.animationDelay = `${i * 120}ms`;

      div.innerHTML = `
        <div class="podiumTitle">${medals[i]} <b>${escapeHtml(p.name)}</b></div>
        <div class="podiumMeta">
          Played: <b>${p.played}</b> ‚Ä¢ W: <b>${p.win}</b> ‚Ä¢ L: <b>${p.lose}</b><br/>
          Points: <b>${p.points}</b> ‚Ä¢ Winrate: <b>${wr}</b>
        </div>
      `;
      elPodium.appendChild(div);
    });
  }

  function render(){
    const list = applyFilterSort(rows);
    elCount.textContent = String(rows.length);
    elTbody.innerHTML = "";

    if (rows.length === 0){
      elTbody.innerHTML = `<tr><td colspan="7" class="muted">Data kosong / belum kebaca dari CSV.</td></tr>`;
      return;
    }

    list.forEach((p, idx)=>{
      const wr = winrate(p).toFixed(1) + "%";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="muted">${idx+1}</td>
        <td><b>${escapeHtml(p.name)}</b></td>
        <td class="num">${p.played}</td>
        <td class="num">${p.win}</td>
        <td class="num">${p.lose}</td>
        <td class="num"><b>${p.points}</b></td>
        <td class="num">${wr}</td>
      `;
      elTbody.appendChild(tr);
    });
  }

  async function load(){
    try{
      const res = await fetch(CSV_URL, { cache: "no-store" });
      const text = await res.text();
      const parsed = parseCSV(text);

      rows = parsed.length ? toPlayers(parsed) : [];

      // ‚úÖ Re-trigger podium animation on refresh:
      // Clear first so new nodes animate again
      elPodium.innerHTML = "";
      renderPodium(rows);
      render();
    } catch (err){
      elTbody.innerHTML = `<tr><td colspan="7" class="muted">Gagal load data CSV. Cek publish settings / koneksi internet.</td></tr>`;
      elPodium.innerHTML = "";
      console.error(err);
    }
  }

  elSortBy.addEventListener("change", () => {
  elPodium.innerHTML = "";       // biar animasi ke-trigger ulang
  renderPodium(rows);            // update podium sesuai mode sort
  render();                      // update tabel
});
  elSortBy.addEventListener("change", render);

  load();
  setInterval(load, 60000);
</script>
</body>
</html>
